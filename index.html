<!DOCTYPE html>
<html lang="ar" dir="rtl" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إِذَاعَة القُرآن الكريم - sar7an_1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Tajawal', sans-serif; background-color: #0f172a; color: #f8fafc; margin: 0; padding-bottom: 160px; }
        .prayer-card { aspect-ratio: 1 / 1; background: #1e293b; border-radius: 2.5rem; border: 1px solid rgba(255,255,255,0.05); display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1); }
        .grid-item-custom { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); transition: 0.2s; padding: 12px; border-radius: 15px; cursor: pointer; text-align: center; color: white; font-weight: bold; }
        .grid-item-custom:hover { background: #10b981; border-color: #10b981; }
        .prayer-row { border-bottom: 1px solid rgba(255, 255, 255, 0.05); padding: 10px 0; }
        .prayer-row:last-child { border: none; }
    </style>
</head>
<body>

    <header class="bg-[#1e293b]/90 backdrop-blur-md sticky top-0 z-50 border-b border-white/5">
        <div class="container mx-auto px-4 h-20 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <a href="https://t.me/Sar7an_1" target="_blank" class="flex flex-col items-center justify-center w-14 h-14 bg-blue-500/10 text-blue-400 rounded-2xl border border-blue-500/20 shadow-lg">
                    <i class="fa-solid fa-paper-plane text-lg"></i>
                    <span class="text-[10px] font-bold mt-1 text-blue-400">تليجرام</span>
                </a>
            </div>
            <h1 class="text-xl font-extrabold tracking-tight text-white">إِذَاعَة القُرآن الكريم</h1>
            <div class="w-14"></div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        
        <div class="mb-10 rounded-[2.5rem] bg-gradient-to-br from-emerald-800 to-teal-950 p-8 shadow-2xl relative overflow-hidden border border-white/10">
            <div class="relative z-10 flex flex-col md:flex-row items-center gap-10">
                <div onclick="togglePlay()" class="w-40 h-40 md:w-52 md:h-52 rounded-full bg-white/10 backdrop-blur-xl border-4 border-white/20 flex items-center justify-center cursor-pointer hover:scale-105 transition-all shadow-inner">
                    <div id="play-state-icon" class="text-6xl text-white">
                        <i class="fa-solid fa-play ml-2"></i>
                    </div>
                </div>
                <div class="text-center md:text-right text-white">
                    <span class="bg-emerald-500/20 px-4 py-1 rounded-full text-[10px] font-bold tracking-widest uppercase border border-white/10" id="live-tag">جاهز للتشغيل</span>
                    <h2 id="current-name" class="text-3xl md:text-5xl font-black mt-4 mb-2 leading-tight">اختر إذاعة</h2>
                    <p id="current-reciter" class="text-lg opacity-70 italic">بواسطة sar7an_1</p>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-8">
            <div class="prayer-card">
                <i class="fa-solid fa-hourglass-start text-amber-500 text-2xl mb-2"></i>
                <span class="text-[10px] text-gray-400 font-bold uppercase text-center px-2">متبقي لصلاة <span id="next-prayer-name">...</span></span>
                <div id="time-left" class="text-2xl font-black mt-1 text-white leading-none">00:00:00</div>
            </div>
            <div class="prayer-card">
                <i class="fa-solid fa-clock text-emerald-500 text-2xl mb-2"></i>
                <span class="text-[10px] text-gray-400 font-bold uppercase">الوقت الآن</span>
                <div id="live-clock" class="text-2xl font-black mt-1 text-white leading-none">--:--</div>
            </div>
        </div>

        <div class="bg-[#1e293b]/50 rounded-[2.5rem] p-8 border border-white/5 mb-12 shadow-lg">
            <h3 class="text-center text-gray-400 font-bold text-xs mb-4 uppercase tracking-widest" id="prayer-header">جاري تحديد موقعك بدقة...</h3>
            
            <div class="flex justify-between items-center mb-6 px-2 border-b border-white/5 pb-4">
                <div class="text-right">
                    <p class="text-[10px] text-gray-400 uppercase font-bold">الميلادي</p>
                    <span id="gregorian-date" class="text-sm font-bold text-emerald-500"></span>
                </div>
                <div class="text-left">
                    <p class="text-[10px] text-gray-400 uppercase font-bold">الهجري</p>
                    <span id="hijri-date" class="text-sm font-bold text-amber-500">...</span>
                </div>
            </div>

            <div class="grid grid-cols-3 gap-6 text-center text-white">
                <div class="prayer-row"> <p class="text-[10px] opacity-60 mb-1">الفجر</p> <p class="font-black text-emerald-400" id="fajr">-</p> </div>
                <div class="prayer-row"> <p class="text-[10px] opacity-60 mb-1">الشروق</p> <p class="font-black" id="sunrise">-</p> </div>
                <div class="prayer-row"> <p class="text-[10px] opacity-60 mb-1">الظهر</p> <p class="font-black" id="dhuhr">-</p> </div>
                <div class="prayer-row"> <p class="text-[10px] opacity-60 mb-1">العصر</p> <p class="font-black" id="asr">-</p> </div>
                <div class="prayer-row"> <p class="text-[10px] opacity-60 mb-1">المغرب</p> <p class="font-black text-orange-400" id="maghrib">-</p> </div>
                <div class="prayer-row"> <p class="text-[10px] opacity-60 mb-1">العشاء</p> <p class="font-black" id="isha">-</p> </div>
            </div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 mb-12">
            <div onclick="openReadersModal()" class="p-8 bg-[#1e293b] rounded-[3rem] border-2 border-transparent hover:border-emerald-600 transition-all cursor-pointer group shadow-xl">
                <h4 class="font-black text-xl mb-1 text-white">المصحف المرتل</h4>
                <p class="text-gray-500 text-sm font-bold">11 شيخ - 114 سورة</p>
            </div>
            <div onclick="openRadioModal()" class="p-8 bg-[#1e293b] rounded-[3rem] border-2 border-transparent hover:border-blue-600 transition-all cursor-pointer group shadow-xl">
                <h4 class="font-black text-xl mb-1 text-white">إذاعات القراء</h4>
                <p class="text-gray-500 text-sm font-bold">بث مباشر متواصل</p>
            </div>
        </div>
    </main>

    <audio id="main-audio" crossorigin="anonymous"></audio>

    <script>
        const audio = document.getElementById('main-audio');
        let pTimes = {};

        // 1. الوظيفة الأساسية لتحديد الموقع
        function initLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => getPrayerData(pos.coords.latitude, pos.coords.longitude), // نجح في جلب الـ GPS
                    () => fetchByIP() // رفض المستخدم أو فشل الـ GPS، نستخدم الـ IP
                );
            } else {
                fetchByIP();
            }
        }

        async function fetchByIP() {
            try {
                const res = await fetch('https://ipapi.co/json/');
                const data = await res.json();
                getPrayerData(data.latitude, data.longitude);
            } catch(e) { console.error("Location error"); }
        }

        async function getPrayerData(lat, lon) {
            try {
                // ترجمة الموقع للعربي
                const geoRes = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&accept-language=ar`);
                const geoData = await geoRes.json();
                const city = geoData.address.state || geoData.address.city || geoData.address.governorate || "منطقتك";
                document.getElementById('prayer-header').innerText = `مواقيت الصلاة حسب ${city}`;

                // جلب المواقيت
                const prayRes = await fetch(`https://api.aladhan.com/v1/timings?latitude=${lat}&longitude=${lon}&method=5`);
                const prayData = await prayRes.json();
                pTimes = prayData.data.timings;
                
                // تاريخ هجري
                const hj = prayData.data.date.hijri;
                document.getElementById('hijri-date').innerText = `${hj.day} ${hj.month.ar} ${hj.year}`;

                // عرض المواقيت
                document.getElementById('fajr').innerText = convertTo12h(pTimes.Fajr);
                document.getElementById('sunrise').innerText = convertTo12h(pTimes.Sunrise);
                document.getElementById('dhuhr').innerText = convertTo12h(pTimes.Dhuhr);
                document.getElementById('asr').innerText = convertTo12h(pTimes.Asr);
                document.getElementById('maghrib').innerText = convertTo12h(pTimes.Maghrib);
                document.getElementById('isha').innerText = convertTo12h(pTimes.Isha);
            } catch (e) { console.error(e); }
        }

        function convertTo12h(time) {
            let [h, m] = time.split(':');
            let sfx = h >= 12 ? ' م' : ' ص';
            h = h % 12 || 12;
            return `${h}:${m}${sfx}`;
        }

        function updateClock() {
            const now = new Date();
            document.getElementById('gregorian-date').innerText = now.toLocaleDateString('ar-EG', { day: 'numeric', month: 'long', year: 'numeric' });
            document.getElementById('live-clock').innerText = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true }).replace('AM', 'ص').replace('PM', 'م');

            if (pTimes.Fajr) {
                const prayers = [
                    {n: "الفجر", t: pTimes.Fajr}, {n: "الظهر", t: pTimes.Dhuhr}, 
                    {n: "العصر", t: pTimes.Asr}, {n: "المغرب", t: pTimes.Maghrib}, {n: "العشاء", t: pTimes.Isha}
                ];
                let nextP = null; let minDiff = Infinity;
                prayers.forEach(p => {
                    const [h, m] = p.t.split(':');
                    const pDate = new Date(); pDate.setHours(h, m, 0);
                    if (pDate < now) pDate.setDate(pDate.getDate() + 1);
                    const diff = pDate - now;
                    if (diff < minDiff) { minDiff = diff; nextP = p; }
                });
                document.getElementById('next-prayer-name').innerText = nextP.n;
                const hrs = Math.floor(minDiff / 3600000);
                const mins = Math.floor((minDiff % 3600000) / 60000);
                const secs = Math.floor((minDiff % 60000) / 1000);
                document.getElementById('time-left').innerText = `${String(hrs).padStart(2,'0')}:${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}`;
            }
        }

        initLocation();
        setInterval(updateClock, 1000);
        // (باقي أكواد التشغيل والمودالات تظل كما هي في النسخة السابقة)
    </script>
</body>
</html>